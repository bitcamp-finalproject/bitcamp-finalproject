select * from aim_follow;


select * from aim_member;

5678

5 > 678
678 > 5

insert into aim_follow(following_no, follower_no) value 
(5,6),
(5,7),
(5,8),
(8,5),
(7,5),
(6,5);

insert into aim_follow(following_no,follower_no) values(12, 5);





insert into aim_info_list(no, name, description) values
(1, "성별","성별의 공개 여부를 설정합니다."),
(2, "생일","생일의 공개 여부를 설정합니다."),
(3, "전화번호","전화번호의 공개 여부를 설정합니다."),
(4, "주소","주소의 공개 여부를 설정합니다."),
(5, "게시물","게시물의 공개 여부를 설정합니다."),
(6, "좋아요 및 조회수","게시물의 좋아요 및 조회수의 공개 여부를 설정합니다."),
(7, "댓글","나의 게시물에 대한 댓글 공개 범위를 설정합니다.");

select * from aim_info_list il
left join aim_hide_setting hs on il.no=hs.no and hs.member_no = #{memberNo}
left join aim_public_range pr on hs.range_no=pr.range_no;

    update aim_hide_setting
    set range_no=1
    where member_no=12 and no=1;




    select
      at.type_no,
      at.alarm_type,
      a.member_no
    from aim_alarm_type at
    left join aim_alarm a
      on a.type=at.type_no and a.member_no = 12
    order by at.type_no;



select count(range_no) from aim_hide_setting where no=5 and member_no=12 and range_no=2;
select hs.range_no from aim_hide_setting hs inner join aim_public_range pr on hs.range_no=pr.range_no where no=5 and member_no=12


   SELECT 
    count(b.board_no)
  FROM 
    aim_board b
  INNER JOIN aim_member m ON b.member_no = m.member_no 
  INNER JOIN aim_generated_img i ON b.board_no = i.board_no
  WHERE (select count(range_no) from aim_hide_setting hs where hs.no='5' and hs.member_no=m.member_no and range_no=2) != 1;

  select count(board_no) from aim_board where member_no=5;




ALTER TABLE aim_alarm_log 
ADD COLUMN reply_no int(11) DEFAULT NULL AFTER other_no,
MODIFY COLUMN other_no int(11) DEFAULT NULL;

ALTER TABLE aim_alarm_log 
ADD COLUMN follow_no int(11) DEFAULT NULL AFTER other_no;



ALTER TABLE aim_alarm_log 
MODIFY COLUMN reply_no int(11) DEFAULT NULL AFTER board_no,
MODIFY COLUMN follow_no int(11) DEFAULT NULL AFTER reply_no,
MODIFY COLUMN content text NOT NULL AFTER other_no;

ALTER TABLE aim_alarm_log 
MODIFY COLUMN content text NOT NULL AFTER follow_no;


----------------------------- Log table 생성
CREATE TABLE aim_log_type (
  type_no    INTEGER        NOT NULL COMMENT '로그유형번호',
  log_type VARCHAR(50)      NOT NULL COMMENT '로그유형이름',
  log_comment VARCHAR(255)  NOT NULL COMMENT '로그유형설명'
);

ALTER TABLE aim_log_type
  ADD CONSTRAINT PK_aim_log_type
  PRIMARY KEY ( type_no );

ALTER TABLE aim_log_type
  MODIFY COLUMN type_no INTEGER NOT NULL AUTO_INCREMENT;

-------------------------------

CREATE TABLE aim_log (
  log_no     INTEGER  NOT NULL COMMENT '로그번호',
  type_no    INTEGER  NOT NULL COMMENT '로그유형번호',
  member_no  INTEGER  NOT NULL COMMENT '회원번호',
  content_no INTEGER  NOT NULL COMMENT '컨텐츠번호',
  content    TEXT         NULL COMMENT '로그내용',
  read_flag  BOOLEAN  NOT NULL DEFAULT 0 COMMENT '읽음여부',
  log_dt     DATETIME NOT NULL DEFAULT now() COMMENT '로그기록일'
);

ALTER TABLE aim_log
  ADD CONSTRAINT PK_aim_log
  PRIMARY KEY ( log_no );

ALTER TABLE aim_log
  MODIFY COLUMN log_no INTEGER NOT NULL AUTO_INCREMENT;

ALTER TABLE aim_log
  ADD CONSTRAINT FK_aim_log_type_TO_aim_log
  FOREIGN KEY ( type_no )
  REFERENCES aim_log_type ( type_no );

ALTER TABLE aim_log
  ADD CONSTRAINT FK_aim_member_TO_aim_log
  FOREIGN KEY ( member_no )
  REFERENCES aim_member ( member_no );

  ------------------------------------------------------------ insert log type data
INSERT INTO aim_log_type (type_no, log_type, log_comment)
VALUES 
  (1, '회원가입', '계정이 생성되었습니다.'), 
  (2, '로그인', '사용자가 로그인하였습니다.'),
  (3, '로그아웃', '사용자가 로그아웃하였습니다.'),

  (11, '게시글작성', '게시글을 작성했습니다.'),
  (12, '게시글수정', '게시글을 수정했습니다.'),
  (13, '게시글삭제', '게시글을 삭제했습니다.'),
  (14, '게시글좋아요', '게시글을 좋아합니다.'),

  (21, '댓글작성', '댓글을 작성했습니다.'),
  (22, '댓글수정', '댓글을 수정했습니다.'),
  (23, '댓글삭제', '댓글을 삭제했습니다.'),
  (24, '댓글좋아요', '댓글을 좋아합니다.'),

  (31, '팔로우', '팔로워가 되었습니다.');

UPDATE aim_log SET content = '팔로워가 되었습니다.' WHERE content = '님을 팔로우합니다.';

  ------------------------------------------------------------ insert log data

INSERT INTO aim_log (type_no, member_no, content_no, content)
VALUES 
  (1, 1234, 5678, '로그 내용입니다.'); -- tmp


INSERT INTO aim_log (type_no, member_no, content_no, content)
VALUES 
  (11, 5, 5, '조쉬가 개시글을 작성했다?'); -- tmp

INSERT INTO aim_log (type_no, member_no, content_no, content)
VALUES 
  (14, 5, 59, '조쉬가 내 개시글을 좋아한다?'); -- tmp

    select * from aim_log
    where type_no=11 and member_no in (select follower_no from aim_follow where following_no=12)
    union
    select * from aim_log
    where type_no=14 and content_no in (select board_no from aim_board where member_no=12)
    union
    select * from aim_log
    where type_no=21 and content_no in (select reply_no from aim_reply where board_no in (select board_no from aim_board where member_no=12))
    union
    select * from aim_log
    where type_no=24 and content_no in (select reply_no from aim_reply where member_no=12)
    union
    select * from aim_log
    where type_no=31 and content_no=12
order by log_no DESC;

    select * from aim_log
    where type_no=11 and member_no in (select follower_no from aim_follow where following_no=#{memberNo})
    union
    select * from aim_log
    where type_no=14 and content_no in (select board_no from aim_board where member_no=#{memberNo})
    union
    select * from aim_log
    where type_no=21 and content_no in (select reply_no from aim_reply where board_no in (select board_no from aim_board where member_no=#{memberNo}))
    union
    select * from aim_log
    where type_no=24 and content_no in (select reply_no from aim_reply where member_no=#{memberNo})
    union
    select * from aim_log
    where type_no=31 and content_no=#{memberNo}


UPDATE aim_log 
JOIN (
    SELECT log_no FROM aim_log 
    WHERE type_no=11 AND member_no IN (
        SELECT follower_no FROM aim_follow WHERE following_no=12
    )
    UNION
    SELECT log_no FROM aim_log
    WHERE type_no=14 AND content_no IN (
        SELECT board_no FROM aim_board WHERE member_no=12
    )
    UNION
    SELECT log_no FROM aim_log
    WHERE type_no=21 AND content_no IN (
        SELECT reply_no FROM aim_reply WHERE board_no IN (
            SELECT board_no FROM aim_board WHERE member_no=12
        )
    )
    UNION
    SELECT log_no FROM aim_log
    WHERE type_no=24 AND content_no IN (
        SELECT reply_no FROM aim_reply WHERE member_no=12
    )
    UNION
    SELECT log_no FROM aim_log
    WHERE type_no=31 AND content_no=12
) AS sub_query
ON aim_log.log_no = sub_query.log_no
SET read_flag=0;